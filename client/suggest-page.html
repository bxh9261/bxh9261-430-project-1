<html>
  <head>
    <title>Alignment Chart Creator</title> 
    <link href="default-styles.css" type="text/css" rel="stylesheet" />

    <script>
  	"use strict";
    const parseJSON = (xhr, content) => {
    	if(xhr.response && xhr.getResponseHeader('Content-Type') === 'application/json'){
      	const obj = JSON.parse(xhr.response);
      	console.dir(obj);
      	
      	if(obj.message){
      		content.innerHTML += `<p>${obj.message}</p>`;
      	}
      }
    };

    const handleResponse = (xhr, media, charac, image) => {
      const content = document.querySelector('#suggestContent');
      const imgHTML = '<img src="' + image + '" alt="' + charac + '" width="100" height="100">'
        
      switch(xhr.status){
      	case 200:
      		content.innerHTML = '<b>Success!</b>';
      		break;
      	case 201:
      		content.innerHTML = '<b>Created character: ' + charac + ', from ' + media + ', with image: <br>' + imgHTML + '</b>';
            content.innerHTML += `<p>Note: If you don't see an image above, try a different image link!</p>`;
      		break;
      	case 204:
      		content.innerHTML = '<b>Character Updated, with image: </b> <br>' + imgHTML;
            content.innerHTML += `<p>Note: If you don't see an image above, try a different image link!</p>`;  
      		break;
      	case 400:
      		content.innerHTML = '<b>Bad Request!</b>';
      		break;
      	default:
      		content.innerHTML = '<b>Error code not implemented by client</b>';
      }
      
      parseJSON(xhr,content);
    };

    const sendPost = (e, nameForm) => {
			e.preventDefault();
			
			const nameAction = nameForm.getAttribute("action");
			const nameMethod = nameForm.getAttribute("method");
			
			const charField = nameForm.querySelector("#char");
			const imageField = nameForm.querySelector("#charimg");
            const mediaField = nameForm.querySelector("#medianame")
			
			const xhr = new XMLHttpRequest();
			xhr.open(nameMethod,nameAction); // NEW - in the past we've been using "GET"
			
			xhr.setRequestHeader('Accept','application/json');
			xhr.setRequestHeader('Content-Type','application/x-www-form-urlencoded');
			// what is "x-www-form-urlencoded"
			// for GET we already saw it - ex. "/unauthorized?loggedIn=yes&valid=true"
			// everything after the question mark is urlencoded
			// multiple key=value pairs are separated by the &
			// HTML forms also encode their values this way
			// in the form below the values are encoded as "name=someValue&age=someValue"
			// https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods/POST
			
			xhr.onload = () => handleResponse(xhr, mediaField.value, charField.value, imageField.value);
			
			const formData = `media=${mediaField.value}&char=${charField.value}&img=${imageField.value}`;
            
			xhr.send(formData); // NEW - in the past we haven't been sending anything here because ...
			// ... our data has always been encoded in the URL
			/// ... instead of being in a separate file as it is now
			
			/*
				Things to try:
				1) Add new users, we should see "201 Created" status code
				- look in the Request tab of the debugger to see the form data
				- Recall that every time the server reboots we lose our data because `users` in jsonResponses.js is re-initialized 
				2) Update a new user (i.e. send the same name) again - we'll see "204 No Content"
				3) Leave off name or age and get back a "400 Bad Request"
				4) In the debugger, you can see that the Network request is being made via XHR
				5) Disable the XHR and you can see the Network request is being made via the form (and we're getting taken to a new page)
				6) Re-enable the XHR and get rid of the `action` and `method` of the form and make the XHR work
			*/
			
			return false; // prevents event bubbling
    };

    const init = () => {
      const nameForm = document.querySelector('#nameForm');
      
      const addUser = (e) => sendPost(e, nameForm);
      
     	nameForm.addEventListener('submit', addUser);
    };

    window.onload = init;

  </script>  
  </head>
  <body>
    <header>
      <div class="topnav">
        <a href="/">Home</a>
        <a href="/app">App</a>
        <a href="/suggest" class="active">Suggest</a>
        <a href="/admin">Admin</a>
      </div>
    </header>
      
  <section id="top" class="redbox">
    <h3>Add a Character</h3>
    <form id="nameForm" action="/add-character" method="post">
        <label for="medianame">Name of Media</label>
      <input type="text" id="medianame" name="medianame"><br><br>

      <div id="char1div">
          <label for="char1">Character Name:</label>
          <input type="text" id="char" name="char1"><br><br>
          <label for="char1img">Character Image URL:</label>
          <input type="text" id="charimg" name="char1img"><br><br>    
      </div>
      <div id="addCharButton">
          <input type="submit" value="Add User" />
      </div>
    </form>
  </section>
  <section id="suggestContent" class="redbox">
      Add a character to the alignment charts app using the form above!
  </section>   
    
  </body>
</html>